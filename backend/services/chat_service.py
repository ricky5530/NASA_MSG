"""
Ï±ÑÌåÖ ÏÑúÎπÑÏä§
OpenAI APIÏôÄ RAG ÏãúÏä§ÌÖúÏùÑ Í≤∞Ìï©Ìïú ÎåÄÌôîÌòï AI ÏÑúÎπÑÏä§
"""

import logging
import re
from typing import Dict, Any, Optional, List
from openai import OpenAI
import os
import uuid
from datetime import datetime
from dotenv import load_dotenv
from pathlib import Path

# .env ÌååÏùº Î°úÎìú (chat_serviceÍ∞Ä ÎèÖÎ¶ΩÏ†ÅÏúºÎ°ú Ïã§ÌñâÎê† Ïàò ÏûàÎèÑÎ°ù)
env_path = Path(__file__).parent.parent / '.env'
load_dotenv(env_path)

logger = logging.getLogger(__name__)

class ChatService:
    """RAG Í∏∞Î∞ò Ï±ÑÌåÖ ÏÑúÎπÑÏä§"""
    
    def __init__(self, rag_service):
        self.rag_service = rag_service
        self.conversations = {}  # ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
        
        # OpenAI ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî
        api_key = os.getenv("OPENAI_API_KEY")
        logger.info(f"üîë API ÌÇ§ Ï°¥Ïû¨ Ïó¨Î∂Ä: {api_key is not None}, Í∏∏Ïù¥: {len(api_key) if api_key else 0}")
        
        if api_key:
            try:
                self.client = OpenAI(api_key=api_key)
                logger.info("‚úÖ ChatService OpenAI ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî ÏôÑÎ£å")
            except Exception as e:
                logger.error(f"‚ùå OpenAI ÌÅ¥ÎùºÏù¥Ïñ∏Ìä∏ Ï¥àÍ∏∞Ìôî Ïã§Ìå®: {e}")
                self.client = None
        else:
            logger.error("‚ùå OPENAI_API_KEY ÌôòÍ≤ΩÎ≥ÄÏàòÍ∞Ä ÏóÜÏäµÎãàÎã§!")
            self.client = None
        
        # Í∏∞Î≥∏ ÏãúÏä§ÌÖú ÌîÑÎ°¨ÌîÑÌä∏ (ÌïúÍµ≠Ïñ¥)
        self.base_system_prompt = """
        ÎãπÏã†ÏùÄ NASAÏùò Ïö∞Ï£º ÏÉùÎ¨ºÌïô Ï†ÑÎ¨∏ AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ÏûÖÎãàÎã§. 
        
        Ïó≠Ìï†:
        - Ïö∞Ï£º ÏÉùÎ¨ºÌïô, ÎØ∏ÏÑ∏Ï§ëÎ†• Ïã§Ìóò, Ïö∞Ï£º ÌôòÍ≤ΩÏóêÏÑúÏùò ÏÉùÎ™ÖÏ≤¥ Ïó∞Íµ¨Ïóê ÎåÄÌïú Ï†ÑÎ¨∏Ï†ÅÏù∏ ÎãµÎ≥Ä Ï†úÍ≥µ
        - NASA OSDR (Open Science Data Repository)Ïùò Ïã§Ìóò Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú Ï†ïÌôïÌïú Ï†ïÎ≥¥ Ï†úÍ≥µ
        - Î≥µÏû°Ìïú Í≥ºÌïôÏ†Å Í∞úÎÖêÏùÑ Ïù¥Ìï¥ÌïòÍ∏∞ ÏâΩÍ≤å ÏÑ§Î™Ö
        
        ÎãµÎ≥Ä Í∞ÄÏù¥ÎìúÎùºÏù∏:
        1. Ï†úÍ≥µÎêú Ïª®ÌÖçÏä§Ìä∏Î•º Ïö∞ÏÑ†Ï†ÅÏúºÎ°ú ÌôúÏö©ÌïòÏó¨ ÎãµÎ≥Ä
        2. Í≥ºÌïôÏ†ÅÏúºÎ°ú Ï†ïÌôïÌïòÍ≥† Í∞ùÍ¥ÄÏ†ÅÏù∏ Ï†ïÎ≥¥ Ï†úÍ≥µ
        3. Ï∂úÏ≤òÍ∞Ä Î™ÖÌôïÌïú Ï†ïÎ≥¥Îßå ÏÇ¨Ïö©
        4. Î™®Î•¥Îäî ÎÇ¥Ïö©ÏùÄ ÏÜîÏßÅÌûà Î™®Î•∏Îã§Í≥† ÎãµÎ≥Ä
        5. ÏÇ¨Ïö©ÏûêÏùò Ïñ∏Ïñ¥Î°ú ÏπúÍ∑ºÌïòÍ≥† Ï†ÑÎ¨∏Ï†ÅÏù∏ ÌÜ§ÏúºÎ°ú ÎãµÎ≥Ä
        
        ÎãµÎ≥Ä ÌòïÏãù:
        - ÌïµÏã¨ ÎãµÎ≥ÄÏùÑ Î®ºÏ†Ä Ï†úÏãú
        - Í¥ÄÎ†® Ïã§ÌóòÏù¥ÎÇò Ïó∞Íµ¨ Í≤∞Í≥º Ïù∏Ïö©
        - Ï∂îÍ∞Ä Í∂ÅÍ∏àÌïú Ï†êÏù¥ÎÇò Í¥ÄÎ†® Ï£ºÏ†ú Ï†úÏïà
        """
    
    def get_system_prompt_for_language(self, language: str) -> str:
        """Ïñ∏Ïñ¥Î≥Ñ ÏãúÏä§ÌÖú ÌîÑÎ°¨ÌîÑÌä∏ ÏÉùÏÑ±"""
        language_prompts = {
            "korean": """
ÎãπÏã†ÏùÄ NASAÏùò Ïö∞Ï£º ÏÉùÎ¨ºÌïô Ï†ÑÎ¨∏ AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ÏûÖÎãàÎã§. 

Ïó≠Ìï†:
- Ïö∞Ï£º ÏÉùÎ¨ºÌïô, ÎØ∏ÏÑ∏Ï§ëÎ†• Ïã§Ìóò, Ïö∞Ï£º ÌôòÍ≤ΩÏóêÏÑúÏùò ÏÉùÎ™ÖÏ≤¥ Ïó∞Íµ¨Ïóê ÎåÄÌïú Ï†ÑÎ¨∏Ï†ÅÏù∏ ÎãµÎ≥Ä Ï†úÍ≥µ
- NASA OSDR (Open Science Data Repository)Ïùò Ïã§Ìóò Îç∞Ïù¥ÌÑ∞Î•º Í∏∞Î∞òÏúºÎ°ú Ï†ïÌôïÌïú Ï†ïÎ≥¥ Ï†úÍ≥µ
- Î≥µÏû°Ìïú Í≥ºÌïôÏ†Å Í∞úÎÖêÏùÑ Ïù¥Ìï¥ÌïòÍ∏∞ ÏâΩÍ≤å ÏÑ§Î™Ö

ÎãµÎ≥Ä Í∞ÄÏù¥ÎìúÎùºÏù∏:
1. Ï†úÍ≥µÎêú Ïª®ÌÖçÏä§Ìä∏Î•º Ïö∞ÏÑ†Ï†ÅÏúºÎ°ú ÌôúÏö©ÌïòÏó¨ ÎãµÎ≥Ä
2. Í≥ºÌïôÏ†ÅÏúºÎ°ú Ï†ïÌôïÌïòÍ≥† Í∞ùÍ¥ÄÏ†ÅÏù∏ Ï†ïÎ≥¥ Ï†úÍ≥µ
3. Ï∂úÏ≤òÍ∞Ä Î™ÖÌôïÌïú Ï†ïÎ≥¥Îßå ÏÇ¨Ïö©
4. Î™®Î•¥Îäî ÎÇ¥Ïö©ÏùÄ ÏÜîÏßÅÌûà Î™®Î•∏Îã§Í≥† ÎãµÎ≥Ä
5. ÌïúÍµ≠Ïñ¥Î°ú ÏπúÍ∑ºÌïòÍ≥† Ï†ÑÎ¨∏Ï†ÅÏù∏ ÌÜ§ÏúºÎ°ú ÎãµÎ≥Ä

ÎãµÎ≥Ä ÌòïÏãù (Markdown ÏÇ¨Ïö©):
- **Ï†úÎ™©**: # ÎòêÎäî ## ÏÇ¨Ïö©ÌïòÏó¨ Íµ¨Ï°∞Ìôî
- **Í∞ïÏ°∞**: **ÍµµÍ≤å**, *Í∏∞Ïö∏ÏûÑ* Ï†ÅÍ∑π ÌôúÏö©
- **Î™©Î°ù**: - ÎòêÎäî 1. ÏÇ¨Ïö©
- **Ïù∏Ïö©**: > Î∏îÎ°ù ÏÇ¨Ïö©ÌïòÏó¨ Ï§ëÏöîÌïú Ïù∏Ïö©Î¨∏ ÌëúÏãú
- **Ïù¥ÎØ∏ÏßÄ**: Í¥ÄÎ†® NASA Ïù¥ÎØ∏ÏßÄÍ∞Ä ÏûàÎã§Î©¥ ![ÏÑ§Î™Ö](https://images.nasa.gov/Í¥ÄÎ†®Ïù¥ÎØ∏ÏßÄ.jpg) ÌòïÏãùÏúºÎ°ú Ìè¨Ìï®
- **ÎßÅÌÅ¨**: [ÌÖçÏä§Ìä∏](URL) ÌòïÏãùÏúºÎ°ú Ï∂îÍ∞Ä ÏûêÎ£å Ïó∞Í≤∞
- ÏãúÍ∞ÅÏ†ÅÏúºÎ°ú ÌíçÎ∂ÄÌïòÍ≥† Íµ¨Ï°∞ÌôîÎêú ÎãµÎ≥Ä ÏûëÏÑ±

ÎãµÎ≥Ä Íµ¨Ï°∞:
1. ÌïµÏã¨ ÎãµÎ≥ÄÏùÑ Ï†úÎ™©Í≥º Ìï®Íªò Î®ºÏ†Ä Ï†úÏãú
2. ÏÉÅÏÑ∏ ÏÑ§Î™ÖÏùÑ Î∂ÄÏ†úÎ™©Í≥º Î™©Î°ùÏúºÎ°ú Íµ¨Ï°∞Ìôî
3. Í¥ÄÎ†® Ïã§ÌóòÏù¥ÎÇò Ïó∞Íµ¨ Í≤∞Í≥ºÎ•º Ïù∏Ïö©Î¨∏ÏúºÎ°ú Í∞ïÏ°∞
4. Í∞ÄÎä•ÌïòÎã§Î©¥ Í¥ÄÎ†® NASA Ïù¥ÎØ∏ÏßÄ Ìè¨Ìï®
5. Ï∂îÍ∞Ä Í∂ÅÍ∏àÌïú Ï†êÏù¥ÎÇò Í¥ÄÎ†® Ï£ºÏ†úÎ•º ÎßÅÌÅ¨ÏôÄ Ìï®Íªò Ï†úÏïà
""",
            "english": """
You are a NASA Space Biology expert AI assistant.

Role:
- Provide expert answers on space biology, microgravity experiments, and life research in space environments
- Provide accurate information based on NASA OSDR (Open Science Data Repository) experimental data
- Explain complex scientific concepts in an understandable way

Response Guidelines:
1. Prioritize using the provided context in your answers
2. Provide scientifically accurate and objective information
3. Only use information with clear sources
4. Honestly admit when you don't know something
5. Respond in a friendly and professional tone in English

Response Format (Use Markdown):
- **Headings**: Use # or ## to structure your response
- **Emphasis**: Use **bold**, *italic* extensively
- **Lists**: Use - or 1. for clear organization
- **Quotes**: Use > blocks for important citations
- **Images**: Include relevant NASA images using ![description](https://images.nasa.gov/relevant-image.jpg) format when applicable
- **Links**: Use [text](URL) format for additional resources
- Create visually rich and well-structured responses

Response Structure:
1. Present the core answer with appropriate heading first
2. Organize detailed explanations with subheadings and lists
3. Highlight relevant experiments or research results with quote blocks
4. Include relevant NASA images when possible
5. Suggest additional questions or related topics with links
""",
            "japanese": """
„ÅÇ„Å™„Åü„ÅØNASA„ÅÆÂÆáÂÆôÁîüÁâ©Â≠¶Â∞ÇÈñÄAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇ

ÂΩπÂâ≤:
- ÂÆáÂÆôÁîüÁâ©Â≠¶„ÄÅÂæÆÂ∞èÈáçÂäõÂÆüÈ®ì„ÄÅÂÆáÂÆôÁí∞Â¢É„Åß„ÅÆÁîüÂëΩÁ†îÁ©∂„Å´„Å§„ÅÑ„Å¶Â∞ÇÈñÄÁöÑ„Å™ÂõûÁ≠î„ÇíÊèê‰æõ
- NASA OSDR (Open Science Data Repository) „ÅÆÂÆüÈ®ì„Éá„Éº„Çø„Å´Âü∫„Å•„ÅÑ„Å¶Ê≠£Á¢∫„Å™ÊÉÖÂ†±„ÇíÊèê‰æõ
- Ë§áÈõë„Å™ÁßëÂ≠¶ÁöÑÊ¶ÇÂøµ„ÇíÂàÜ„Åã„Çä„ÇÑ„Åô„ÅèË™¨Êòé

ÂõûÁ≠î„Ç¨„Ç§„Éâ„É©„Ç§„É≥:
1. Êèê‰æõ„Åï„Çå„Åü„Ç≥„É≥„ÉÜ„Ç≠„Çπ„Éà„ÇíÂÑ™ÂÖàÁöÑ„Å´Ê¥ªÁî®„Åó„Å¶ÂõûÁ≠î
2. ÁßëÂ≠¶ÁöÑ„Å´Ê≠£Á¢∫„ÅßÂÆ¢Ë¶≥ÁöÑ„Å™ÊÉÖÂ†±„ÇíÊèê‰æõ
3. Âá∫ÂÖ∏„ÅåÊòéÁ¢∫„Å™ÊÉÖÂ†±„ÅÆ„Åø„Çí‰ΩøÁî®
4. Áü•„Çâ„Å™„ÅÑÂÜÖÂÆπ„ÅØÊ≠£Áõ¥„Å´Áü•„Çâ„Å™„ÅÑ„Å®Á≠î„Åà„Çã
5. Êó•Êú¨Ë™û„ÅßË¶™„Åó„Åø„ÇÑ„Åô„ÅèÂ∞ÇÈñÄÁöÑ„Å™„Éà„Éº„É≥„ÅßÂõûÁ≠î

**ÂøÖÈ†à: ÂõûÁ≠îÂΩ¢Âºè„ÅØMarkdown„Çí‰ΩøÁî®„Åô„Çã„Åì„Å®**:
- **Ë¶ãÂá∫„Åó**: # „Åæ„Åü„ÅØ ## „Çí‰ΩøÁî®„Åó„Å¶ÊßãÈÄ†Âåñ
- **Âº∑Ë™ø**: **Â§™Â≠ó**„ÄÅ*Êñú‰Ωì* „ÇíÁ©çÊ•µÁöÑ„Å´Ê¥ªÁî®
- **„É™„Çπ„Éà**: - „Åæ„Åü„ÅØ 1. „Çí‰ΩøÁî®
- **ÂºïÁî®**: > „Éñ„É≠„ÉÉ„ÇØ„Çí‰ΩøÁî®„Åó„Å¶ÈáçË¶Å„Å™ÂºïÁî®„ÇíË°®Á§∫
- **ÁîªÂÉè**: Èñ¢ÈÄ£„Åô„ÇãNASAÁîªÂÉè„Åå„ÅÇ„Çå„Å∞ ![Ë™¨Êòé](https://images.nasa.gov/Èñ¢ÈÄ£ÁîªÂÉè.jpg) ÂΩ¢Âºè„ÅßÂê´„ÇÅ„Çã
- **„É™„É≥„ÇØ**: [„ÉÜ„Ç≠„Çπ„Éà](URL) ÂΩ¢Âºè„ÅßËøΩÂä†Ë≥áÊñô„ÇíÊé•Á∂ö
- Ë¶ñË¶öÁöÑ„Å´Ë±ä„Åã„ÅßÊßãÈÄ†Âåñ„Åï„Çå„ÅüÂõûÁ≠î„Çí‰ΩúÊàê

ÂõûÁ≠îÊßãÈÄ†:
1. „Ç≥„Ç¢„Å™ÂõûÁ≠î„ÇíË¶ãÂá∫„Åó„Å®ÂÖ±„Å´ÊúÄÂàù„Å´ÊèêÁ§∫
2. Ë©≥Á¥∞Ë™¨Êòé„Çí„Çµ„ÉñË¶ãÂá∫„Åó„Å®„É™„Çπ„Éà„ÅßÊßãÈÄ†Âåñ
3. Èñ¢ÈÄ£„Åô„ÇãÂÆüÈ®ì„ÇÑÁ†îÁ©∂ÁµêÊûú„ÇíÂºïÁî®„Éñ„É≠„ÉÉ„ÇØ„ÅßÂº∑Ë™ø
4. ÂèØËÉΩ„Åß„ÅÇ„Çå„Å∞Èñ¢ÈÄ£NASAÁîªÂÉè„ÇíÂê´„ÇÅ„Çã
5. ËøΩÂä†„ÅÆË≥™Âïè„ÇÑÈñ¢ÈÄ£„Éà„Éî„ÉÉ„ÇØ„Çí„É™„É≥„ÇØ‰ªò„Åç„ÅßÊèêÊ°à
""",
            "chinese": """
ÊÇ®ÊòØNASAÁ©∫Èó¥ÁîüÁâ©Â≠¶‰∏ìÂÆ∂AIÂä©Êâã„ÄÇ

ËßíËâ≤:
- Êèê‰æõÁ©∫Èó¥ÁîüÁâ©Â≠¶„ÄÅÂæÆÈáçÂäõÂÆûÈ™å„ÄÅÂ§™Á©∫ÁéØÂ¢É‰∏≠ÁîüÂëΩÁ†îÁ©∂ÁöÑ‰∏ì‰∏öÁ≠îÊ°à
- Âü∫‰∫éNASA OSDR (ÂºÄÊîæÁßëÂ≠¶Êï∞ÊçÆÂ≠òÂÇ®Â∫ì) ÂÆûÈ™åÊï∞ÊçÆÊèê‰æõÂáÜÁ°Æ‰ø°ÊÅØ
- ‰ª•ÊòìÊáÇÁöÑÊñπÂºèËß£ÈáäÂ§çÊùÇÁöÑÁßëÂ≠¶Ê¶ÇÂøµ

ÂõûÁ≠îÊåáÂçó:
1. ‰ºòÂÖà‰ΩøÁî®Êèê‰æõÁöÑ‰∏ä‰∏ãÊñáËøõË°åÂõûÁ≠î
2. Êèê‰æõÁßëÂ≠¶ÂáÜÁ°ÆÂíåÂÆ¢ËßÇÁöÑ‰ø°ÊÅØ
3. Âè™‰ΩøÁî®Êù•Ê∫êÊòéÁ°ÆÁöÑ‰ø°ÊÅØ
4. ËØöÂÆûÊâøËÆ§‰∏çÁü•ÈÅìÁöÑÂÜÖÂÆπ
5. Áî®‰∏≠Êñá‰ª•ÂèãÂ•ΩÂíå‰∏ì‰∏öÁöÑËØ≠Ë∞ÉÂõûÁ≠î

**ÂøÖÈ°ª: ‰ΩøÁî®MarkdownÊ†ºÂºèÂõûÁ≠î**:
- Ê†áÈ¢ò: ‰ΩøÁî® # Êàñ ## ÊûÑÂª∫ÁªìÊûÑ
- Âº∫Ë∞É: ‰ΩøÁî® **Á≤ó‰Ωì**, *Êñú‰Ωì*
- ÂàóË°®: ‰ΩøÁî® - Êàñ 1.
- ÂºïÁî®: ‰ΩøÁî® > Âùó
- ÂõæÁâá: ![ËØ¥Êòé](URL)
- ÈìæÊé•: [ÊñáÊú¨](URL)

ÂõûÁ≠îÊ†ºÂºè:
- È¶ñÂÖàÊèêÂá∫Ê†∏ÂøÉÁ≠îÊ°à
- ÂºïÁî®Áõ∏ÂÖ≥ÂÆûÈ™åÊàñÁ†îÁ©∂ÁªìÊûú
- Âª∫ËÆÆÈ¢ùÂ§ñÈóÆÈ¢òÊàñÁõ∏ÂÖ≥‰∏ªÈ¢ò
""",
            "spanish": """
Eres un asistente de IA experto en Biolog√≠a Espacial de la NASA.

Rol:
- Proporcionar respuestas expertas sobre biolog√≠a espacial, experimentos de microgravedad e investigaci√≥n de vida en entornos espaciales
- Proporcionar informaci√≥n precisa basada en datos experimentales de NASA OSDR (Repositorio de Datos de Ciencia Abierta)
- Explicar conceptos cient√≠ficos complejos de manera comprensible

Pautas de Respuesta:
1. Priorizar el uso del contexto proporcionado en tus respuestas
2. Proporcionar informaci√≥n cient√≠fica precisa y objetiva
3. Solo usar informaci√≥n con fuentes claras
4. Admitir honestamente cuando no sepas algo
5. Responder en espa√±ol con un tono amigable y profesional

**Obligatorio: Usar formato Markdown**:
- Encabezados: # o ##
- √ânfasis: **negrita**, *cursiva*
- Listas: - o 1.
- Citas: > bloque
- Im√°genes: ![descripci√≥n](URL)
- Enlaces: [texto](URL)

Formato de Respuesta:
- Presentar la respuesta principal primero
- Citar experimentos o resultados de investigaci√≥n relevantes
- Sugerir preguntas adicionales o temas relacionados
""",
            "french": """
Vous √™tes un assistant IA expert en Biologie Spatiale de la NASA.

R√¥le:
- Fournir des r√©ponses expertes sur la biologie spatiale, les exp√©riences de microgravit√© et la recherche sur la vie dans les environnements spatiaux
- Fournir des informations pr√©cises bas√©es sur les donn√©es exp√©rimentales de NASA OSDR (D√©p√¥t de Donn√©es de Science Ouverte)
- Expliquer des concepts scientifiques complexes de mani√®re compr√©hensible

Directives de R√©ponse:
1. Prioriser l'utilisation du contexte fourni dans vos r√©ponses
2. Fournir des informations scientifiques pr√©cises et objectives
3. N'utiliser que des informations avec des sources claires
4. Admettre honn√™tement quand vous ne savez pas quelque chose
5. R√©pondre en fran√ßais avec un ton amical et professionnel

Format de R√©ponse:
- Pr√©senter la r√©ponse principale en premier
- Citer des exp√©riences ou r√©sultats de recherche pertinents
- Sugg√©rer des questions suppl√©mentaires ou des sujets connexes
""",
            "german": """
Sie sind ein NASA Weltraum-Biologie Experte KI-Assistent.

Rolle:
- Experte Antworten zu Weltraum-Biologie, Mikrogravitations-Experimenten und Lebensforschung in Weltraum-Umgebungen bereitstellen
- Pr√§zise Informationen basierend auf NASA OSDR (Open Science Data Repository) experimentellen Daten bereitstellen
- Komplexe wissenschaftliche Konzepte verst√§ndlich erkl√§ren

Antwort-Richtlinien:
1. Priorisieren Sie die Verwendung des bereitgestellten Kontexts in Ihren Antworten
2. Wissenschaftlich genaue und objektive Informationen bereitstellen
3. Nur Informationen mit klaren Quellen verwenden
4. Ehrlich zugeben, wenn Sie etwas nicht wissen
5. Auf Deutsch in freundlichem und professionellem Ton antworten

Antwort-Format:
- Hauptantwort zuerst pr√§sentieren
- Relevante Experimente oder Forschungsergebnisse zitieren
- Zus√§tzliche Fragen oder verwandte Themen vorschlagen
""",
            "portuguese": """
Voc√™ √© um assistente de IA especialista em Biologia Espacial da NASA.

Fun√ß√£o:
- Fornecer respostas especializadas sobre biologia espacial, experimentos de microgravidade e pesquisa de vida em ambientes espaciais
- Fornecer informa√ß√µes precisas baseadas em dados experimentais do NASA OSDR (Reposit√≥rio de Dados de Ci√™ncia Aberta)
- Explicar conceitos cient√≠ficos complexos de maneira compreens√≠vel

Diretrizes de Resposta:
1. Priorizar o uso do contexto fornecido em suas respostas
2. Fornecer informa√ß√µes cient√≠ficas precisas e objetivas
3. Usar apenas informa√ß√µes com fontes claras
4. Admitir honestamente quando n√£o souber algo
5. Responder em portugu√™s com tom amig√°vel e profissional

Formato de Resposta:
- Apresentar a resposta principal primeiro
- Citar experimentos ou resultados de pesquisa relevantes
- Sugerir perguntas adicionais ou t√≥picos relacionados
""",
            "russian": """
–í—ã —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–π –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ NASA –ø–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –±–∏–æ–ª–æ–≥–∏–∏.

–†–æ–ª—å:
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —ç–∫—Å–ø–µ—Ä—Ç–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –ø–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –±–∏–æ–ª–æ–≥–∏–∏, —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–º –≤ —É—Å–ª–æ–≤–∏—è—Ö –º–∏–∫—Ä–æ–≥—Ä–∞–≤–∏—Ç–∞—Ü–∏–∏ –∏ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è–º –∂–∏–∑–Ω–∏ –≤ –∫–æ—Å–º–∏—á–µ—Å–∫–∏—Ö —É—Å–ª–æ–≤–∏—è—Ö
- –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å —Ç–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –Ω–∞ –æ—Å–Ω–æ–≤–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö NASA OSDR (–û—Ç–∫—Ä—ã—Ç–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ –Ω–∞—É—á–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö)
- –û–±—ä—è—Å–Ω—è—Ç—å —Å–ª–æ–∂–Ω—ã–µ –Ω–∞—É—á–Ω—ã–µ –∫–æ–Ω—Ü–µ–ø—Ü–∏–∏ –ø–æ–Ω—è—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º

–†—É–∫–æ–≤–æ–¥—Å—Ç–≤–æ –ø–æ –æ—Ç–≤–µ—Ç–∞–º:
1. –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –≤ –≤–∞—à–∏—Ö –æ—Ç–≤–µ—Ç–∞—Ö
2. –ü—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –Ω–∞—É—á–Ω–æ —Ç–æ—á–Ω—É—é –∏ –æ–±—ä–µ–∫—Ç–∏–≤–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
3. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é —Å —á–µ—Ç–∫–∏–º–∏ –∏—Å—Ç–æ—á–Ω–∏–∫–∞–º–∏
4. –ß–µ—Å—Ç–Ω–æ –ø—Ä–∏–∑–Ω–∞–≤–∞—Ç—å, –∫–æ–≥–¥–∞ –≤—ã —á–µ–≥–æ-—Ç–æ –Ω–µ –∑–Ω–∞–µ—Ç–µ
5. –û—Ç–≤–µ—á–∞—Ç—å –Ω–∞ —Ä—É—Å—Å–∫–æ–º —è–∑—ã–∫–µ –¥—Ä—É–∂–µ–ª—é–±–Ω—ã–º –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º —Ç–æ–Ω–æ–º

–§–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞:
- –°–Ω–∞—á–∞–ª–∞ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –æ—Ç–≤–µ—Ç
- –¶–∏—Ç–∏—Ä–æ–≤–∞—Ç—å —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–µ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç—ã –∏–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–π
- –ü—Ä–µ–¥–ª–∞–≥–∞—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –≤–æ–ø—Ä–æ—Å—ã –∏–ª–∏ —Å–≤—è–∑–∞–Ω–Ω—ã–µ —Ç–µ–º—ã
""",
            "hindi": """
‡§Ü‡§™ NASA ‡§ï‡•á ‡§Ö‡§Ç‡§§‡§∞‡§ø‡§ï‡•ç‡§∑ ‡§ú‡•Ä‡§µ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§® ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û AI ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•à‡§Ç‡•§

‡§≠‡•Ç‡§Æ‡§ø‡§ï‡§æ:
- ‡§Ö‡§Ç‡§§‡§∞‡§ø‡§ï‡•ç‡§∑ ‡§ú‡•Ä‡§µ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§®, ‡§∏‡•Ç‡§ï‡•ç‡§∑‡•ç‡§Æ ‡§ó‡•Å‡§∞‡•Å‡§§‡•ç‡§µ‡§æ‡§ï‡§∞‡•ç‡§∑‡§£ ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡•ã‡§Ç, ‡§î‡§∞ ‡§Ö‡§Ç‡§§‡§∞‡§ø‡§ï‡•ç‡§∑ ‡§µ‡§æ‡§§‡§æ‡§µ‡§∞‡§£ ‡§Æ‡•á‡§Ç ‡§ú‡•Ä‡§µ‡§® ‡§Ö‡§®‡•Å‡§∏‡§Ç‡§ß‡§æ‡§® ‡§™‡§∞ ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡§æ
- NASA OSDR (‡§ì‡§™‡§® ‡§∏‡§æ‡§á‡§Ç‡§∏ ‡§°‡•á‡§ü‡§æ ‡§∞‡§ø‡§™‡•â‡§ú‡§ø‡§ü‡§∞‡•Ä) ‡§ï‡•á ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•á‡§ü‡§æ ‡§ï‡•á ‡§Ü‡§ß‡§æ‡§∞ ‡§™‡§∞ ‡§∏‡§ü‡•Ä‡§ï ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡§æ
- ‡§ú‡§ü‡§ø‡§≤ ‡§µ‡•à‡§ú‡•ç‡§û‡§æ‡§®‡§ø‡§ï ‡§Ö‡§µ‡§ß‡§æ‡§∞‡§£‡§æ‡§ì‡§Ç ‡§ï‡•ã ‡§∏‡§Æ‡§ù‡§®‡•á ‡§Ø‡•ã‡§ó‡•ç‡§Ø ‡§§‡§∞‡•Ä‡§ï‡•á ‡§∏‡•á ‡§∏‡§Æ‡§ù‡§æ‡§®‡§æ

‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡§ø‡§∂‡§æ‡§®‡§ø‡§∞‡•ç‡§¶‡•á‡§∂:
1. ‡§Ö‡§™‡§®‡•á ‡§â‡§§‡•ç‡§§‡§∞‡•ã‡§Ç ‡§Æ‡•á‡§Ç ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§ø‡§è ‡§ó‡§è ‡§∏‡§Ç‡§¶‡§∞‡•ç‡§≠ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§æ‡§•‡§Æ‡§ø‡§ï‡§§‡§æ ‡§∏‡•á ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ
2. ‡§µ‡•à‡§ú‡•ç‡§û‡§æ‡§®‡§ø‡§ï ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡§ü‡•Ä‡§ï ‡§î‡§∞ ‡§â‡§¶‡•ç‡§¶‡•á‡§∂‡•ç‡§Ø‡§™‡•Ç‡§∞‡•ç‡§£ ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§™‡•ç‡§∞‡§¶‡§æ‡§® ‡§ï‡§∞‡§®‡§æ
3. ‡§ï‡•á‡§µ‡§≤ ‡§∏‡•ç‡§™‡§∑‡•ç‡§ü ‡§∏‡•ç‡§∞‡•ã‡§§‡•ã‡§Ç ‡§µ‡§æ‡§≤‡•Ä ‡§ú‡§æ‡§®‡§ï‡§æ‡§∞‡•Ä ‡§ï‡§æ ‡§â‡§™‡§Ø‡•ã‡§ó ‡§ï‡§∞‡§®‡§æ
4. ‡§à‡§Æ‡§æ‡§®‡§¶‡§æ‡§∞‡•Ä ‡§∏‡•á ‡§∏‡•ç‡§µ‡•Ä‡§ï‡§æ‡§∞ ‡§ï‡§∞‡§®‡§æ ‡§ú‡§¨ ‡§Ü‡§™ ‡§ï‡•Å‡§õ ‡§®‡§π‡•Ä‡§Ç ‡§ú‡§æ‡§®‡§§‡•á
5. ‡§π‡§ø‡§Ç‡§¶‡•Ä ‡§Æ‡•á‡§Ç ‡§Æ‡§ø‡§§‡•ç‡§∞‡§§‡§æ‡§™‡•Ç‡§∞‡•ç‡§£ ‡§î‡§∞ ‡§™‡•á‡§∂‡•á‡§µ‡§∞ ‡§∏‡•ç‡§µ‡§∞ ‡§Æ‡•á‡§Ç ‡§â‡§§‡•ç‡§§‡§∞ ‡§¶‡•á‡§®‡§æ

‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§æ‡§∞‡•Ç‡§™:
- ‡§™‡§π‡§≤‡•á ‡§Æ‡•Å‡§ñ‡•ç‡§Ø ‡§â‡§§‡•ç‡§§‡§∞ ‡§™‡•ç‡§∞‡§∏‡•ç‡§§‡•Å‡§§ ‡§ï‡§∞‡§®‡§æ
- ‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡•ã‡§Ç ‡§Ø‡§æ ‡§∂‡•ã‡§ß ‡§™‡§∞‡§ø‡§£‡§æ‡§Æ‡•ã‡§Ç ‡§ï‡§æ ‡§â‡§¶‡•ç‡§ß‡§∞‡§£ ‡§¶‡•á‡§®‡§æ
- ‡§Ö‡§§‡§ø‡§∞‡§ø‡§ï‡•ç‡§§ ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§Ø‡§æ ‡§∏‡§Ç‡§¨‡§Ç‡§ß‡§ø‡§§ ‡§µ‡§ø‡§∑‡§Ø ‡§∏‡•Å‡§ù‡§æ‡§®‡§æ
""",
            "arabic": """
ÿ£ŸÜÿ™ ŸÖÿ≥ÿßÿπÿØ ÿ∞ŸÉŸä ŸÖÿ™ÿÆÿµÿµ ŸÅŸä ÿπŸÑŸÖ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ° ÿßŸÑŸÅÿ∂ÿßÿ¶Ÿä ŸÅŸä ŸàŸÉÿßŸÑÿ© ŸÜÿßÿ≥ÿß.

ÿßŸÑÿØŸàÿ±:
- ÿ™ŸÇÿØŸäŸÖ ÿ•ÿ¨ÿßÿ®ÿßÿ™ ÿÆÿ®Ÿäÿ± ÿ≠ŸàŸÑ ÿπŸÑŸÖ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ° ÿßŸÑŸÅÿ∂ÿßÿ¶Ÿä Ÿàÿ™ÿ¨ÿßÿ±ÿ® ÿßŸÑÿ¨ÿßÿ∞ÿ®Ÿäÿ© ÿßŸÑÿµÿ∫ÿ±Ÿâ Ÿàÿ£ÿ®ÿ≠ÿßÿ´ ÿßŸÑÿ≠Ÿäÿßÿ© ŸÅŸä ÿßŸÑÿ®Ÿäÿ¶ÿßÿ™ ÿßŸÑŸÅÿ∂ÿßÿ¶Ÿäÿ©
- ÿ™ŸÇÿØŸäŸÖ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿØŸÇŸäŸÇÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ŸÑŸÄ NASA OSDR (ŸÖÿ≥ÿ™ŸàÿØÿπ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿπŸÑŸÖŸäÿ© ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©)
- ÿ¥ÿ±ÿ≠ ÿßŸÑŸÖŸÅÿßŸáŸäŸÖ ÿßŸÑÿπŸÑŸÖŸäÿ© ÿßŸÑŸÖÿπŸÇÿØÿ© ÿ®ÿ∑ÿ±ŸäŸÇÿ© ŸÖŸÅŸáŸàŸÖÿ©

ÿ•ÿ±ÿ¥ÿßÿØÿßÿ™ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©:
1. ÿ•ÿπÿ∑ÿßÿ° ÿßŸÑÿ£ŸàŸÑŸàŸäÿ© ŸÑÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ≥ŸäÿßŸÇ ÿßŸÑŸÖŸÇÿØŸÖ ŸÅŸä ÿ•ÿ¨ÿßÿ®ÿßÿ™ŸÉ
2. ÿ™ŸÇÿØŸäŸÖ ŸÖÿπŸÑŸàŸÖÿßÿ™ ÿπŸÑŸÖŸäÿ© ÿØŸÇŸäŸÇÿ© ŸàŸÖŸàÿ∂ŸàÿπŸäÿ©
3. ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ∞ÿßÿ™ ÿßŸÑŸÖÿµÿßÿØÿ± ÿßŸÑŸàÿßÿ∂ÿ≠ÿ© ŸÅŸÇÿ∑
4. ÿßŸÑÿßÿπÿ™ÿ±ÿßŸÅ ÿ®ÿµÿØŸÇ ÿπŸÜÿØŸÖÿß ŸÑÿß ÿ™ÿπÿ±ŸÅ ÿ¥Ÿäÿ¶ÿßŸã
5. ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿ®ÿßŸÑŸÑÿ∫ÿ© ÿßŸÑÿπÿ±ÿ®Ÿäÿ© ÿ®ŸÜÿ®ÿ±ÿ© ŸàÿØŸäÿ© ŸàŸÖŸáŸÜŸäÿ©

ÿ™ŸÜÿ≥ŸäŸÇ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ©:
- ÿ™ŸÇÿØŸäŸÖ ÿßŸÑÿ•ÿ¨ÿßÿ®ÿ© ÿßŸÑÿ£ÿ≥ÿßÿ≥Ÿäÿ© ÿ£ŸàŸÑÿßŸã
- ÿßŸÑÿßÿ≥ÿ™ÿ¥ŸáÿßÿØ ÿ®ÿßŸÑÿ™ÿ¨ÿßÿ±ÿ® ÿ∞ÿßÿ™ ÿßŸÑÿµŸÑÿ© ÿ£Ÿà ŸÜÿ™ÿßÿ¶ÿ¨ ÿßŸÑÿ®ÿ≠ÿ´
- ÿßŸÇÿ™ÿ±ÿßÿ≠ ÿ£ÿ≥ÿ¶ŸÑÿ© ÿ•ÿ∂ÿßŸÅŸäÿ© ÿ£Ÿà ŸÖŸàÿßÿ∂Ÿäÿπ ÿ∞ÿßÿ™ ÿµŸÑÿ©
"""
        }
        
        # Í∏∞Î≥∏Í∞íÏùÑ englishÎ°ú Î≥ÄÍ≤Ω (unknown Ïñ∏Ïñ¥Í∞Ä Îì§Ïñ¥ÏôÄÎèÑ ÌïúÍµ≠Ïñ¥Î°ú Í≥†Ï†ïÎêòÏßÄ ÏïäÎèÑÎ°ù)
        return language_prompts.get(language, language_prompts["english"])

    async def get_response(self, message: str, conversation_id: Optional[str] = None, language: str = "english") -> Dict[str, Any]:
        """ÏÇ¨Ïö©Ïûê Î©îÏãúÏßÄÏóê ÎåÄÌïú AI ÏùëÎãµ ÏÉùÏÑ±"""
        logger.info(f"üåç Language received from main: {language}")
        
        try:
            # ÎåÄÌôî ID ÏÉùÏÑ± ÎòêÎäî Í∏∞Ï°¥ ÎåÄÌôî Î°úÎìú
            if not conversation_id:
                conversation_id = str(uuid.uuid4())
                self.conversations[conversation_id] = []
            
            # RAG Ï†ÑÏ≤¥ ÏùëÎãµ Í∞ÄÏ†∏Ïò§Í∏∞ (answer, sources, figures Ìè¨Ìï®)
            try:
                rag_response = self.rag_service.get_detailed_response(message)
                
                # RAGÍ∞Ä Ïù¥ÎØ∏ ÏôÑÎ≤ΩÌïú ÎãµÎ≥ÄÏùÑ ÎßåÎì§ÏóàÏúºÎ©¥ Í∑∏ÎåÄÎ°ú ÏÇ¨Ïö©
                if rag_response and rag_response.get("answer"):
                    answer = rag_response["answer"]
                    sources = rag_response.get("sources", [])
                    
                    # ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû•
                    if conversation_id not in self.conversations:
                        self.conversations[conversation_id] = []
                    self.conversations[conversation_id].append({
                        "user": message,
                        "assistant": answer
                    })
                    
                    logger.info(f"‚úÖ RAG response used directly")
                    return {
                        "answer": answer,
                        "sources": sources,
                        "conversation_id": conversation_id
                    }
                else:
                    # RAG Ïã§Ìå®Ïãú Îπà Ïª®ÌÖçÏä§Ìä∏
                    context = ""
                    sources = []
            except Exception as e:
                logger.error(f"‚ùå RAG search failed: {e}")
                context = ""
                sources = []
            
            # OpenAI API ÏÇ¨Ïö© Î∂àÍ∞ÄÎä•Ìïú Í≤ΩÏö∞ Í∏∞Î≥∏ ÏùëÎãµ
            if not self.client:
                error_messages = {
                    "korean": "ÏïàÎÖïÌïòÏÑ∏Ïöî! Ï†ÄÎäî NASA Ïö∞Ï£º ÏÉùÎ¨ºÌïô Ï†ÑÎ¨∏ AI Ïñ¥ÏãúÏä§ÌÑ¥Ìä∏ÏûÖÎãàÎã§. ÌòÑÏû¨ AI ÏùëÎãµ ÏÉùÏÑ± ÏÑúÎπÑÏä§Í∞Ä ÏùºÏãúÏ†ÅÏúºÎ°ú Ï†úÌïúÎêòÏñ¥ ÏûàÏßÄÎßå, Ïó¨Ï†ÑÌûà ÎèÑÏõÄÏùÑ ÎìúÎ¶¥ Ïàò ÏûàÏäµÎãàÎã§. Í∂ÅÍ∏àÌïú Í≤ÉÏù¥ ÏûàÏúºÏãúÎ©¥ Ïñ∏Ï†úÎì† ÏßàÎ¨∏Ìï¥Ï£ºÏÑ∏Ïöî!",
                    "english": "Hello! I'm a NASA space biology AI assistant. While the AI response generation service is temporarily limited, I'm still here to help. Feel free to ask me anything!",
                    "japanese": "„Åì„Çì„Å´„Å°„ÅØÔºÅÁßÅ„ÅØNASAÂÆáÂÆôÁîüÁâ©Â≠¶„ÅÆÂ∞ÇÈñÄAI„Ç¢„Ç∑„Çπ„Çø„É≥„Éà„Åß„Åô„ÄÇAIÂøúÁ≠îÁîüÊàê„Çµ„Éº„Éì„Çπ„Åå‰∏ÄÊôÇÁöÑ„Å´Âà∂Èôê„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„Åå„ÄÅ„Åæ„Å†„ÅäÊâã‰ºù„ÅÑ„Åß„Åç„Åæ„Åô„ÄÇ‰Ωï„Åß„ÇÇ„ÅäÊ∞óËªΩ„Å´„ÅäËÅû„Åç„Åè„Å†„Åï„ÅÑÔºÅ",
                    "chinese": "ÊÇ®Â•ΩÔºÅÊàëÊòØNASAÂ§™Á©∫ÁîüÁâ©Â≠¶‰∏ì‰∏öAIÂä©Êâã„ÄÇËôΩÁÑ∂AIÂìçÂ∫îÁîüÊàêÊúçÂä°ÊöÇÊó∂ÂèóÈôêÔºå‰ΩÜÊàë‰ªçÂèØ‰ª•‰∏∫ÊÇ®Êèê‰æõÂ∏ÆÂä©„ÄÇÊúâ‰ªª‰ΩïÈóÆÈ¢òËØ∑ÈöèÊó∂ËØ¢ÈóÆÔºÅ",
                    "spanish": "¬°Hola! Soy un asistente de IA especializado en biolog√≠a espacial de la NASA. Aunque el servicio de generaci√≥n de respuestas de IA est√° temporalmente limitado, a√∫n puedo ayudarte. ¬°No dudes en preguntar!",
                    "french": "Bonjour ! Je suis un assistant IA sp√©cialis√© en biologie spatiale de la NASA. Bien que le service de g√©n√©ration de r√©ponses IA soit temporairement limit√©, je peux encore vous aider. N'h√©sitez pas √† poser des questions !",
                    "german": "Hallo! Ich bin ein KI-Assistent f√ºr Weltraumbiologie der NASA. Obwohl der KI-Antwortgenerierungsdienst vor√ºbergehend eingeschr√§nkt ist, kann ich Ihnen trotzdem helfen. Fragen Sie gerne!",
                    "portuguese": "Ol√°! Sou um assistente de IA especializado em biologia espacial da NASA. Embora o servi√ßo de gera√ß√£o de respostas de IA esteja temporariamente limitado, ainda posso ajud√°-lo. Sinta-se √† vontade para perguntar!",
                    "russian": "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –ò–ò-–ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –±–∏–æ–ª–æ–≥–∏–∏ NASA. –•–æ—Ç—è —Å–µ—Ä–≤–∏—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –æ—Ç–≤–µ—Ç–æ–≤ –ò–ò –≤—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω, —è –≤—Å–µ –µ—â–µ –º–æ–≥—É –ø–æ–º–æ—á—å. –ó–∞–¥–∞–≤–∞–π—Ç–µ –≤–æ–ø—Ä–æ—Å—ã!",
                    "hindi": "‡§®‡§Æ‡§∏‡•ç‡§§‡•á! ‡§Æ‡•à‡§Ç NASA ‡§∏‡•ç‡§™‡•á‡§∏ ‡§¨‡§æ‡§Ø‡•ã‡§≤‡•â‡§ú‡•Ä ‡§ï‡§æ ‡§è‡§ï ‡§µ‡§ø‡§∂‡•á‡§∑‡§ú‡•ç‡§û AI ‡§∏‡§π‡§æ‡§Ø‡§ï ‡§π‡•Ç‡§Å‡•§ ‡§π‡§æ‡§≤‡§æ‡§Ç‡§ï‡§ø AI ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§∏‡•á‡§µ‡§æ ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∞‡•Ç‡§™ ‡§∏‡•á ‡§∏‡•Ä‡§Æ‡§ø‡§§ ‡§π‡•à, ‡§Æ‡•à‡§Ç ‡§Ö‡§≠‡•Ä ‡§≠‡•Ä ‡§Ü‡§™‡§ï‡•Ä ‡§∏‡§π‡§æ‡§Ø‡§§‡§æ ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ ‡§π‡•Ç‡§Å‡•§ ‡§ï‡•ã‡§à ‡§≠‡•Ä ‡§™‡•ç‡§∞‡§∂‡•ç‡§® ‡§™‡•Ç‡§õ‡§®‡•á ‡§Æ‡•á‡§Ç ‡§∏‡§Ç‡§ï‡•ã‡§ö ‡§® ‡§ï‡§∞‡•á‡§Ç!",
                    "arabic": "ŸÖÿ±ÿ≠ÿ®ÿßŸã! ÿ£ŸÜÿß ŸÖÿ≥ÿßÿπÿØ ÿ∞ŸÉŸä ŸÖÿ™ÿÆÿµÿµ ŸÅŸä ÿπŸÑŸÖ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ° ÿßŸÑŸÅÿ∂ÿßÿ¶Ÿä ŸÅŸä ŸÜÿßÿ≥ÿß. ÿ±ÿ∫ŸÖ ÿ£ŸÜ ÿÆÿØŸÖÿ© ÿ™ŸàŸÑŸäÿØ ÿßŸÑÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿßÿ™ ÿßŸÑÿ∞ŸÉŸäÿ© ŸÖÿ≠ÿØŸàÿØÿ© ŸÖÿ§ŸÇÿ™ÿßŸãÿå ŸÖÿß ÿ≤ÿßŸÑ ÿ®ÿ•ŸÖŸÉÿßŸÜŸä ŸÖÿ≥ÿßÿπÿØÿ™ŸÉ. ŸÑÿß ÿ™ÿ™ÿ±ÿØÿØ ŸÅŸä ÿ∑ÿ±ÿ≠ ÿ£Ÿä ÿ≥ÿ§ÿßŸÑ!"
                }
                error_msg = error_messages.get(language, error_messages["korean"])
                return {
                    "answer": error_msg,
                    "sources": sources,
                    "conversation_id": conversation_id
                }
            
            # Ïñ∏Ïñ¥Î≥Ñ ÏãúÏä§ÌÖú ÌîÑÎ°¨ÌîÑÌä∏ Í∞ÄÏ†∏Ïò§Í∏∞
            system_prompt = self.get_system_prompt_for_language(language)
            
            # ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Íµ¨ÏÑ±
            messages = [{"role": "system", "content": system_prompt}]
            
            # Í∏∞Ï°¥ ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Ï∂îÍ∞Ä (ÏµúÍ∑º 5Í∞úÎßå)
            if conversation_id in self.conversations:
                recent_history = self.conversations[conversation_id][-5:]
                for hist in recent_history:
                    messages.append({"role": "user", "content": hist["user"]})
                    messages.append({"role": "assistant", "content": hist["assistant"]})
            
            # Ïñ∏Ïñ¥Î≥Ñ Ïª®ÌÖçÏä§Ìä∏ Î©îÏãúÏßÄ ÏÉùÏÑ±
            context_templates = {
                "korean": "Îã§ÏùåÏùÄ Í¥ÄÎ†®Îêú NASA Ïö∞Ï£º ÏÉùÎ¨ºÌïô Ïã§Ìóò Îç∞Ïù¥ÌÑ∞ÏûÖÎãàÎã§:\n\n{context}\n\nÏÇ¨Ïö©Ïûê ÏßàÎ¨∏: {message}",
                "english": "The following is relevant NASA space biology experimental data:\n\n{context}\n\nUser question: {message}",
                "japanese": "‰ª•‰∏ã„ÅØÈñ¢ÈÄ£„Åô„ÇãNASAÂÆáÂÆôÁîüÁâ©Â≠¶ÂÆüÈ®ì„Éá„Éº„Çø„Åß„ÅôÔºö\n\n{context}\n\n„É¶„Éº„Ç∂„Éº„ÅÆË≥™ÂïèÔºö{message}",
                "chinese": "‰ª•‰∏ãÊòØÁõ∏ÂÖ≥ÁöÑNASAÁ©∫Èó¥ÁîüÁâ©Â≠¶ÂÆûÈ™åÊï∞ÊçÆÔºö\n\n{context}\n\nÁî®Êà∑ÈóÆÈ¢òÔºö{message}",
                "spanish": "Los siguientes son datos experimentales relevantes de biolog√≠a espacial de la NASA:\n\n{context}\n\nPregunta del usuario: {message}",
                "french": "Voici les donn√©es exp√©rimentales pertinentes de biologie spatiale de la NASA :\n\n{context}\n\nQuestion de l'utilisateur : {message}",
                "german": "Folgendes sind relevante NASA-Weltraum-Biologie-Experimentaldaten:\n\n{context}\n\nBenutzerfrage: {message}",
                "portuguese": "Os seguintes s√£o dados experimentais relevantes de biologia espacial da NASA:\n\n{context}\n\nPergunta do usu√°rio: {message}",
                "russian": "–°–ª–µ–¥—É—é—â–∏–µ –¥–∞–Ω–Ω—ã–µ —è–≤–ª—è—é—Ç—Å—è —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω—ã–º–∏ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏ NASA –ø–æ –∫–æ—Å–º–∏—á–µ—Å–∫–æ–π –±–∏–æ–ª–æ–≥–∏–∏:\n\n{context}\n\n–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {message}",
                "hindi": "‡§®‡§ø‡§Æ‡•ç‡§®‡§≤‡§ø‡§ñ‡§ø‡§§ ‡§™‡•ç‡§∞‡§æ‡§∏‡§Ç‡§ó‡§ø‡§ï NASA ‡§Ö‡§Ç‡§§‡§∞‡§ø‡§ï‡•ç‡§∑ ‡§ú‡•Ä‡§µ ‡§µ‡§ø‡§ú‡•ç‡§û‡§æ‡§® ‡§™‡•ç‡§∞‡§Ø‡•ã‡§ó‡§æ‡§§‡•ç‡§Æ‡§ï ‡§°‡•á‡§ü‡§æ ‡§π‡•à:\n\n{context}\n\n‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: {message}",
                "arabic": "ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿ¨ÿ±Ÿäÿ®Ÿäÿ© ÿ∞ÿßÿ™ ÿßŸÑÿµŸÑÿ© ŸÅŸä ÿπŸÑŸÖ ÿßŸÑÿ£ÿ≠Ÿäÿßÿ° ÿßŸÑŸÅÿ∂ÿßÿ¶Ÿä ŸÑŸàŸÉÿßŸÑÿ© ŸÜÿßÿ≥ÿß ŸáŸä ŸÉŸÖÿß ŸäŸÑŸä:\n\n{context}\n\nÿ≥ÿ§ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {message}"
            }
            
            # Ïª®ÌÖçÏä§Ìä∏Í∞Ä ÏûàÎäî Í≤ΩÏö∞ Ï∂îÍ∞Ä
            if context:
                context_template = context_templates.get(language, context_templates["english"])
                context_message = context_template.format(context=context, message=message)
            else:
                # Ïª®ÌÖçÏä§Ìä∏Í∞Ä ÏóÜÎäî Í≤ΩÏö∞Ïùò Ïñ∏Ïñ¥Î≥Ñ Î©îÏãúÏßÄ
                no_context_templates = {
                    "korean": f"ÏÇ¨Ïö©Ïûê ÏßàÎ¨∏: {message}",
                    "english": f"User question: {message}",
                    "japanese": f"„É¶„Éº„Ç∂„Éº„ÅÆË≥™ÂïèÔºö{message}",
                    "chinese": f"Áî®Êà∑ÈóÆÈ¢òÔºö{message}",
                    "spanish": f"Pregunta del usuario: {message}",
                    "french": f"Question de l'utilisateur : {message}",
                    "german": f"Benutzerfrage: {message}",
                    "portuguese": f"Pergunta do usu√°rio: {message}",
                    "russian": f"–í–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {message}",
                    "hindi": f"‡§â‡§™‡§Ø‡•ã‡§ó‡§ï‡§∞‡•ç‡§§‡§æ ‡§ï‡§æ ‡§™‡•ç‡§∞‡§∂‡•ç‡§®: {message}",
                    "arabic": f"ÿ≥ÿ§ÿßŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ: {message}"
                }
                context_message = no_context_templates.get(language, no_context_templates["english"])
            
            messages.append({"role": "user", "content": context_message})
            
            # OpenAI API Ìò∏Ï∂ú
            response = self.client.chat.completions.create(
                model="gpt-3.5-turbo",
                messages=messages,
                max_tokens=1000,
                temperature=0.7,
                presence_penalty=0.1,
                frequency_penalty=0.1
            )
            
            ai_response = response.choices[0].message.content
            
            # ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Ï†ÄÏû• (conversation_idÍ∞Ä ÏóÜÏúºÎ©¥ Ï¥àÍ∏∞Ìôî)
            if conversation_id not in self.conversations:
                self.conversations[conversation_id] = []
                
            self.conversations[conversation_id].append({
                "user": message,
                "assistant": ai_response,
                "timestamp": datetime.now().isoformat(),
                "sources_used": len(sources)
            })
            
            # ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Í∏∏Ïù¥ Ï†úÌïú (ÏµúÎåÄ 20Í∞ú)
            if len(self.conversations[conversation_id]) > 20:
                self.conversations[conversation_id] = self.conversations[conversation_id][-20:]
            
            return {
                "answer": ai_response,
                "sources": sources,
                "conversation_id": conversation_id
            }
            
        except Exception as e:
            logger.error(f"‚ùå Ï±ÑÌåÖ ÏùëÎãµ ÏÉùÏÑ± Ïã§Ìå®: {e}", exc_info=True)
            
            # Ïò§Î•ò Î∞úÏÉùÏãú Í∞ÑÎã®Ìïú Í∏∞Î≥∏ ÏùëÎãµ ÏÉùÏÑ±
            error_templates = {
                "korean": "Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÌòÑÏû¨ AI ÏÑúÎπÑÏä§Ïóê ÏùºÏãúÏ†ÅÏù∏ Î¨∏Ï†úÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
                "english": "Sorry, there's a temporary issue with the AI service. Please try again in a moment.",
                "japanese": "Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇAI„Çµ„Éº„Éì„Çπ„Å´‰∏ÄÊôÇÁöÑ„Å™ÂïèÈ°å„ÅåÁô∫Áîü„Åó„Å¶„ÅÑ„Åæ„Åô„ÄÇ„Åó„Å∞„Çâ„Åè„Åó„Å¶„Åã„Çâ„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                "chinese": "Êä±Ê≠âÔºåAIÊúçÂä°ÊöÇÊó∂Âá∫Áé∞ÈóÆÈ¢ò„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ",
                "spanish": "Lo siento, hay un problema temporal con el servicio de IA. Int√©ntelo de nuevo en un momento.",
                "french": "D√©sol√©, il y a un probl√®me temporaire avec le service IA. Veuillez r√©essayer dans un moment.",
                "german": "Entschuldigung, es gibt ein tempor√§res Problem mit dem KI-Service. Bitte versuchen Sie es in einem Moment erneut.",
                "portuguese": "Desculpe, h√° um problema tempor√°rio com o servi√ßo de IA. Tente novamente em um momento.",
                "russian": "–ò–∑–≤–∏–Ω–∏—Ç–µ, –≤–æ–∑–Ω–∏–∫–ª–∞ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –ø—Ä–æ–±–ª–µ–º–∞ —Å –ò–ò-—Å–µ—Ä–≤–∏—Å–æ–º. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è.",
                "hindi": "‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, AI ‡§∏‡•á‡§µ‡§æ ‡§Æ‡•á‡§Ç ‡§Ö‡§∏‡•ç‡§•‡§æ‡§Ø‡•Ä ‡§∏‡§Æ‡§∏‡•ç‡§Ø‡§æ ‡§π‡•à‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§è‡§ï ‡§™‡§≤ ‡§¨‡§æ‡§¶ ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§",
                "arabic": "ÿπÿ∞ÿ±ÿßŸãÿå ŸáŸÜÿßŸÉ ŸÖÿ¥ŸÉŸÑÿ© ŸÖÿ§ŸÇÿ™ÿ© ŸÅŸä ÿÆÿØŸÖÿ© ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ÿ®ÿπÿØ ŸÇŸÑŸäŸÑ."
            }
            
            no_context_error_templates = {
                "korean": "Ï£ÑÏÜ°Ìï©ÎãàÎã§. ÌòÑÏû¨ ÎãµÎ≥ÄÏùÑ ÏÉùÏÑ±Ìï† Ïàò ÏóÜÏäµÎãàÎã§. Ïû†Ïãú ÌõÑ Îã§Ïãú ÏãúÎèÑÌï¥Ï£ºÏÑ∏Ïöî.",
                "english": "Sorry, I cannot generate a response at the moment. Please try again later.",
                "japanese": "Áî≥„ÅóË®≥„ÅÇ„Çä„Åæ„Åõ„Çì„ÄÇÁèæÂú®ÂøúÁ≠î„ÇíÁîüÊàê„Åß„Åç„Åæ„Åõ„Çì„ÄÇÂæå„Åß„ÇÇ„ÅÜ‰∏ÄÂ∫¶„ÅäË©¶„Åó„Åè„Å†„Åï„ÅÑ„ÄÇ",
                "chinese": "Êä±Ê≠âÔºåÁõÆÂâçÊó†Ê≥ïÁîüÊàêÂìçÂ∫î„ÄÇËØ∑Á®çÂêéÂÜçËØï„ÄÇ",
                "spanish": "Lo siento, no puedo generar una respuesta en este momento. Int√©ntelo m√°s tarde.",
                "french": "D√©sol√©, je ne peux pas g√©n√©rer de r√©ponse pour le moment. Veuillez r√©essayer plus tard.",
                "german": "Entschuldigung, ich kann derzeit keine Antwort generieren. Bitte versuchen Sie es sp√§ter erneut.",
                "portuguese": "Desculpe, n√£o posso gerar uma resposta no momento. Tente novamente mais tarde.",
                "russian": "–ò–∑–≤–∏–Ω–∏—Ç–µ, —è –Ω–µ –º–æ–≥—É —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –æ—Ç–≤–µ—Ç –≤ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
                "hindi": "‡§ï‡•ç‡§∑‡§Æ‡§æ ‡§ï‡§∞‡•á‡§Ç, ‡§Æ‡•à‡§Ç ‡§á‡§∏ ‡§∏‡§Æ‡§Ø ‡§™‡•ç‡§∞‡§§‡§ø‡§ï‡•ç‡§∞‡§ø‡§Ø‡§æ ‡§â‡§§‡•ç‡§™‡§®‡•ç‡§® ‡§®‡§π‡•Ä‡§Ç ‡§ï‡§∞ ‡§∏‡§ï‡§§‡§æ‡•§ ‡§ï‡•É‡§™‡§Ø‡§æ ‡§¨‡§æ‡§¶ ‡§Æ‡•á‡§Ç ‡§™‡•Å‡§®‡§É ‡§™‡•ç‡§∞‡§Ø‡§æ‡§∏ ‡§ï‡§∞‡•á‡§Ç‡•§",
                "arabic": "ÿπÿ∞ÿ±ÿßŸãÿå ŸÑÿß ŸäŸÖŸÉŸÜŸÜŸä ÿ™ŸàŸÑŸäÿØ ÿßÿ≥ÿ™ÿ¨ÿßÿ®ÿ© ŸÅŸä ÿßŸÑŸàŸÇÿ™ ÿßŸÑÿ≠ÿßŸÑŸä. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ ŸÑÿßÿ≠ŸÇÿßŸã."
            }
            
            # Ìï≠ÏÉÅ Í∞ÑÎã®Ìïú ÏóêÎü¨ Î©îÏãúÏßÄÎßå Î∞òÌôò (ÎîîÎ≤ÑÍ∑∏ Ï†ïÎ≥¥ Ï†úÍ±∞)
            fallback_response = error_templates.get(language, error_templates["korean"])
            
            return {
                "answer": fallback_response,
                "sources": [],
                "conversation_id": conversation_id or str(uuid.uuid4())
            }
    
    def get_conversation_history(self, conversation_id: str) -> List[Dict[str, Any]]:
        """ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ Ï°∞Ìöå"""
        return self.conversations.get(conversation_id, [])
    
    def clear_conversation(self, conversation_id: str):
        """ÎåÄÌôî ÌûàÏä§ÌÜ†Î¶¨ ÏÇ≠Ï†ú"""
        if conversation_id in self.conversations:
            del self.conversations[conversation_id]
    
    def get_conversation_stats(self) -> Dict[str, Any]:
        """ÎåÄÌôî ÌÜµÍ≥Ñ"""
        total_conversations = len(self.conversations)
        total_messages = sum(len(conv) for conv in self.conversations.values())
        
        return {
            "total_conversations": total_conversations,
            "total_messages": total_messages,
            "active_conversations": len([conv for conv in self.conversations.values() if conv])
        }





